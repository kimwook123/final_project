{% extends "history_sidebar.html" %}

{% block main_content %}
<div class="container mt-5">
    <h2 class="text-center">챗봇과의 대화</h2>
    <div class="chat-container" id="chatContainer" style="height: 60vh; overflow-y: auto;">
        <!-- 채팅 메시지 표시 -->
    </div>
    <div class="input-group mt-3">
        <input type="text" class="form-control" id="userInput" placeholder="메시지를 입력하세요.">
        <div class="input-group-append">
            <button class="btn btn-primary" id="sendButton">전송</button>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="{{ url_for('static', filename='js/shared.js') }}"></script>
<script>
    // 텍스트 챗봇의 기본 URL 설정
    const baseUrl = "/chatbot";
    
    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById('sendButton').addEventListener('click', sendMessage);
        document.getElementById('userInput').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });
        updateSidebar('/chatbot/get_history', (historyId) => loadChatHistory(historyId, '/chatbot'));
    });
    async function sendMessage() {
        const userInput = document.getElementById('userInput').value;
        if (!userInput) return;
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message user-message';
        userMessageDiv.textContent = userInput;
        document.getElementById('chatContainer').appendChild(userMessageDiv);
        document.getElementById('userInput').value = '';
        document.getElementById('userInput').setAttribute('placeholder', '로딩 중...');
        try {
            const response = await axios.post('/chatbot/chat', { message: userInput });
            const botMessageDiv = document.createElement('div');
            botMessageDiv.className = 'message bot-message';
            botMessageDiv.textContent = response.data.response;
            document.getElementById('chatContainer').appendChild(botMessageDiv);
            document.getElementById('userInput').setAttribute('placeholder', '메시지를 입력하세요.');
            await updateSidebar('/chatbot/get_history', (historyId) => loadChatHistory(historyId, '/chatbot'));
        } catch (error) {
            console.error('서버와의 통신 오류:', error);
            document.getElementById('userInput').setAttribute('placeholder', '오류 발생. 다시 시도해 주세요.');
        }
        document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
    }
    async function loadChatHistory(historyId, baseUrl) {
        try {
            const response = await axios.get(`${baseUrl}/get_chat/${historyId}`);
            const chatContentDiv = document.getElementById('chatContainer');
            chatContentDiv.innerHTML = '';
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'message user-message';
            userMessageDiv.textContent = response.data.user_question;
            chatContentDiv.appendChild(userMessageDiv);
            if (response.data.maked_text) {
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'message bot-message';
                botMessageDiv.textContent = response.data.maked_text;
                chatContentDiv.appendChild(botMessageDiv);
            }
            document.getElementById('chatContainer').scrollTop = chatContentDiv.scrollHeight;
        } catch (error) {
            console.error('채팅 기록 불러오기 오류:', error);
            const chatContentDiv = document.getElementById('chatContainer');
            chatContentDiv.innerHTML = `<p>기록을 불러오는데 오류가 발생했습니다.</p>`;
        }
    }
</script>
{% endblock %}