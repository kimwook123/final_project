{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar" style="height: 100vh; overflow-y: auto;">
            <div class="sidebar-sticky">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="sidebar-heading">이전 기록</h5>
                    <button class="btn btn-secondary btn-sm" id="newChatButton">NEW CHAT</button>
                </div>
                <ul class="nav flex-column" id="chatHistoryList">
                    {% if chat_histories %}
                        {% for history in chat_histories %}
                            <li class="nav-item d-flex justify-content-between align-items-center">
                                <a href="#" class="nav-link chat-history-link" data-id="{{ history.id }}" onclick="loadChatHistory(this.dataset.id)">
                                    {{ history.user_question[:20] }}...
                                </a>
                                <button class="btn btn-danger btn-sm delete-button" data-id="{{ history.id }}" onclick="deleteChatHistory(this.dataset.id)">삭제</button>
                            </li>
                        {% endfor %}
                    {% else %}
                        <li class="nav-item">
                            <span>로그인 후 채팅 기록을 볼 수 있습니다.</span>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </nav>
        <main class="col-md-9 ml-sm-auto col-lg-10 px-md-4">
            {% block main_content %}
            <div id="chatContent" class="mt-4">
                <p>기록을 선택하세요.</p>
            </div>
            {% endblock %}
        </main>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        async function deleteChatHistory(historyId) {
            try {
                const response = await axios.delete(`/chatbot/delete_chat/${historyId}`);
                if (response.status === 200) {
                    console.log('채팅 기록 삭제 완료:', historyId);
                    await updateSidebar();
                } else {
                    console.error('채팅 기록 삭제 실패:', response.data);
                }
            } catch (error) {
                console.error('채팅 기록 삭제 오류:', error);
            }
        }
        async function updateSidebar() {
            try {
                const response = await axios.get('/chatbot/get_history');
                const sidebar = document.getElementById('chatHistoryList');
                sidebar.innerHTML = '';
                if (response.data.chat_histories.length === 0) {
                    console.log("No chat histories to display.");
                }
                response.data.chat_histories.forEach(history => {
                    const li = document.createElement('li');
                    li.className = 'nav-item d-flex justify-content-between align-items-center';
                    const link = document.createElement('a');
                    link.className = 'nav-link chat-history-link';
                    link.href = '#';
                    link.textContent = history.user_question.slice(0, 20) + '...';
                    link.dataset.id = history.id;
                    link.addEventListener('click', () => loadChatHistory(history.id));
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'btn btn-danger btn-sm delete-button';
                    deleteBtn.dataset.id = history.id;
                    deleteBtn.textContent = '삭제';
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteChatHistory(history.id);
                    });
                    li.appendChild(link);
                    li.appendChild(deleteBtn);
                    sidebar.appendChild(li);
                });
            } catch (error) {
                console.error('사이드바 업데이트 오류:', error);
            }
        }
        async function loadChatHistory(historyId) {
            try {
                const response = await axios.get(`/chatbot/get_chat/${historyId}`);
                if (response.status === 200) {
                    const chatContentDiv = document.getElementById('chatContent');
                    chatContentDiv.innerHTML = '';
                    const userMessageDiv = document.createElement('div');
                    userMessageDiv.className = 'message user-message';
                    userMessageDiv.textContent = response.data.user_question;
                    chatContentDiv.appendChild(userMessageDiv);
                    if (response.data.maked_text) {
                        const botMessageDiv = document.createElement('div');
                        botMessageDiv.className = 'message bot-message';
                        botMessageDiv.textContent = response.data.maked_text;
                        chatContentDiv.appendChild(botMessageDiv);
                    }
                    document.getElementById('chatContent').scrollTop = chatContentDiv.scrollHeight;
                } else {
                    console.error('기록을 찾을 수 없습니다:', response.data);
                }
            } catch (error) {
                console.error('채팅 기록 불러오기 오류:', error);
                const chatContentDiv = document.getElementById('chatContent');
                chatContentDiv.innerHTML = `<p>기록을 불러오는데 오류가 발생했습니다.</p>`;
            }
        }
        updateSidebar();
    });
</script>
{% endblock %}